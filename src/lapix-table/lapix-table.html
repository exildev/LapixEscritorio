<link rel="import" href="../elements.html">
<dom-module id="lapix-table">
    <style>
        :host {
            display: block;
            padding: 8px;
            --paper-datatable-selection-toolbar-text-color: var(--lapix-text, --primary-text-color);
            --paper-datatable-selection-toolbar-color: var(--lapix-header, --primary-color);
            --paper-datatable-checkbox-border-color: var(--lapix-accent, --accent-color);
            --paper-datatable-header-checkbox-border-color: var(--lapix-accent, --accent-color);
            --paper-datatable-checkbox-color:  var(--lapix-accent, --accent-color);
            --paper-toggle-button-checked-bar-color: var(--lapix-accent, --accent-color);
            --paper-toggle-button-checked-button-color:	var(--lapix-accent, --accent-color);
            --paper-toggle-button-checked-ink-color: var(--lapix-accent, --accent-color);
        }
    </style>
    <template>
        <iron-ajax id="get" url="[[fullUrl]]" handle-as="json" method="GET"></iron-ajax>
        <paper-datatable-card id="datatableCard" header="[[label]]" page-size="10" data-source="{{_dataSource}}" id-property="{{property}}" selected-ids="{{selectedIds}}">
            <div toolbar-main>
                <paper-icon-button icon="cached" on-tap="retrieveResults"></paper-icon-button>
            </div>
            <div toolbar-select>
                <paper-icon-button icon="menu" on-tap="deleteSelected"></paper-icon-button>
            </div>
            <div toolbar-select-single>
                <paper-icon-button icon="menu" on-tap="editDialogForSelected"></paper-icon-button>
            </div>
            <paper-datatable id="datatable" selectable multi-selection selected-items="{{selectedItems}}" >
                <div no-results>
                    Buscando resultados ...
                </div>
                <content></content>
            </paper-datatable>
        </paper-datatable-card>
    </template>
    <script>
        Polymer({
            is: "lapix-table",
            properties: {
                site: {
                    type: String,
                    notify: true
                },
                fullUrl: {
                    type: String,
                    computed: 'computeFullUrl(site)',
                    notify: true
                },
                label: {
                    type: String,
                    notify: true
                },
                property: {
                    type: String,
                    notify: true
                },
                _dataSource: {
                    type: Object
                }

            },
            listeners: {
                'get.response': '_onResponse',
                'get.error': '_onError'
            },
            ready: function() {
                this._dataSource = {
                    get: (sort, page, pageSize) => {
                        this.$.get.params = { page: page, num_page: pageSize, sort_property: sort.property, sort_direction: sort.direction };
                        this.$.get.generateRequest();
                        return new Promise((resolve, reject) => {
                            this._onResponse = evn => {
                                this.set('_dataSource.length', evn.detail.response.count)
                                resolve(evn.detail.response.object_list)
                            };
                            this._onError = evn => {
                                console.warn('Error al consultar los datos', evn);
                                resolve([]);
                            };
                        });
                    },
                    // set: (item, property, value) => {
                    //     console.info('set', item, property, value);
                    //     return new Promise((resolve, reject) => {
                    //         resolve(false);
                    //     })
                    // },
                    length: 0
                };
            },
            retrieveResults: function(ev){
                this.computeFullUrl(this.site);
                this.$.datatableCard.retrieveVisibleData();
            },
            computeFullUrl: function(site){
                return lapix.conf.get('host') + site;
            }
            // deleteSelected: function(evn){
            //     console.log(this.selectedIds);
            // },
            // editDialogForSelected: function () {
            //     console.log(this.selectedIds);
            // },
        });
    </script>
</dom-module>
